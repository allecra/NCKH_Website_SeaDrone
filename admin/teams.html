<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị hệ thống cứu hộ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #overviewMap { 
            width: 100%;
            height: 400px;
            border-radius: 8px;
            min-height: 400px;
        
        .modal {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: #0005; display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 2rem; border-radius: 8px; min-width: 320px; position: relative;
        }
        .modal .close {
            position: absolute; right: 1rem; top: 1rem; cursor: pointer; font-size: 1.5rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; }
        .form-group input { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
        .btn { padding: 0.5rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-life-ring logo-icon"></i>
                    <span>Hệ thống quản lý cứu hộ</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle user-icon"></i>
                    <span class="user-name">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>
        </header>

        <div class="breadcrumb">
            <div class="breadcrumb-container">
                <div class="breadcrumb-content">
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Quản lý đội cứu hộ</span>
            </div>
                </div>
            </div>
        </div>

        <main class="main-content">
        <div class="dashboard-grid">
                <section class="map-section">
                    <div class="section-header">
                        <div>
                            <h2>Bản đồ đội cứu hộ</h2>
                            <p>Xem vị trí các bãi biển và đội cứu hộ</p>
            </div>
                    </div>
                    <div class="map-container">
                        <div id="overviewMap"></div>
                    </div>
                </section>

                <section class="list-section">
                    <div class="section-header" style="align-items: center; justify-content: space-between;">
                        <div>
                            <h2>Danh sách đội cứu hộ</h2>
                            <p>Quản lý thông tin các đội cứu hộ</p>
                        </div>
                        <button class="btn btn-primary" id="addTeamBtn"><i class="fas fa-plus"></i> Thêm đội cứu hộ</button>
                    </div>
                    <div class="beach-list" style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        <!-- Danh sách đội cứu hộ sẽ được thêm vào đây -->
                </div>
                </section>
            </div>
        </main>
        </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
async function fetchTeams() {
    const urlParams = new URLSearchParams(window.location.search);
    const beachId = urlParams.get('beach_id');
    const res = await fetch(`http://localhost:3009/api/Team${beachId ? '?beach_id=' + beachId : ''}`);
    return await res.json();
}

async function renderTeams() {
    // Lấy beach_id từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const beachId = urlParams.get('beach_id');

    const teams = await fetchTeams();
    // Không cần filter nữa, teams đã được backend lọc theo beach_id

    const teamList = document.querySelector('.beach-list');
    teamList.innerHTML = teams.length ? teams.map(team => `
        <div class="beach-card" data-team-id="${team.team_id}">
            <div class="beach-actions">
                <button class="btn btn-primary btn-edit" title="Sửa"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-delete" title="Xóa"><i class="fas fa-trash"></i></button>
            </div>
            <h3>${team.team_name}</h3>
            <div><b>Mã quản lý:</b> ${team.manager_id || ''}</div>
            <div><i class="fas fa-map-marker-alt"></i> <b>Vị trí:</b> ${team.location?.lat || ''}, ${team.location?.lng || ''}</div>
        </div>
    `).join('') : `<div>Không có đội cứu hộ nào cho bãi biển này.</div>`;

    // Gắn sự kiện click vào card để chuyển trang
    document.querySelectorAll('.beach-card').forEach(card => {
        card.onclick = function(e) {
            // Nếu click vào nút Sửa/Xóa thì không chuyển trang
            if (e.target.closest('.btn-edit') || e.target.closest('.btn-delete')) return;
            const id = card.getAttribute('data-team-id');
            window.location.href = `user.html?team_id=${id}`;
        }
    });
    // Gắn sự kiện
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            const card = this.closest('.beach-card');
            openModal('teamModal', 'edit', card.getAttribute('data-team-id'));
        }
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            const card = this.closest('.beach-card');
            openModal('deleteTeamModal', 'delete', card.getAttribute('data-team-id'));
        }
    });
    renderMap(teams);
}

function renderMap(teams) {
    if (window._overviewMap) {
        window._overviewMap.remove();
    }
    if (!teams || teams.length === 0) return;
    const first = teams.find(b => b.location && b.location.lat && b.location.lng);
    window._overviewMap = L.map('overviewMap').setView([
        first ? first.location.lat : 16.047079,
        first ? first.location.lng : 108.206230
    ], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(window._overviewMap);
    teams.forEach(team => {
        if (team.location && team.location.lat && team.location.lng) {
            L.marker([team.location.lat, team.location.lng])
                .addTo(window._overviewMap)
                .bindPopup(`<b>${team.team_name}</b><br>${team.location.lat}, ${team.location.lng}`);
        }
    });
}

// Modal logic
function openModal(modalId, mode, id) {
    document.getElementById(modalId).style.display = 'flex';
    if(modalId === 'teamModal') {
        const title = document.getElementById('teamModalTitle');
        const form = document.getElementById('teamForm');
        if(!mode) mode = 'add';
        if(!id) id = '';
        if(mode === 'add' && id) {
            alert('Không thể thêm đội cứu hộ với ID đã có');
            closeModal('teamModal');
            return;
        }
        if(mode === 'edit') {
            title.textContent = 'Sửa đội cứu hộ';
            fetch(`http://localhost:3009/api/Team`)
                .then(res => res.json())
                .then(teams => {
                    const team = teams.find(b => b.team_id === id);
                    if(!team) {
                        alert('Không tìm thấy đội cứu hộ');
                        closeModal('teamModal');
                        return;
                    }
                    form.reset();
                    document.getElementById('beachId').value = team.beach_id || '';
                    document.getElementById('teamId').value = team.team_id;
                    document.getElementById('teamName').value = team.team_name;
                    document.getElementById('managerId').value = team.manager_id;
                    document.getElementById('lat').value = team.location?.lat || '';
                    document.getElementById('lng').value = team.location?.lng || '';
                });
        } else {
            title.textContent = 'Thêm đội cứu hộ';
            form.reset();
            document.getElementById('teamId').value = '';
        }
    }
    if(modalId === 'deleteTeamModal') {
        document.getElementById('confirmDeleteTeamBtn').onclick = async function() {
            await fetch(`http://localhost:3009/api/Team/${id}`, { method: 'DELETE' });
            closeModal('deleteTeamModal');
            renderTeams();
        }
    }
}
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Thêm/Sửa đội cứu hộ
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('addTeamBtn').onclick = () => openModal('teamModal', 'add');
    document.getElementById('teamForm').onsubmit = async function(e) {
        e.preventDefault();
        // Lấy giá trị từ form
        const urlParams = new URLSearchParams(window.location.search);
        const beachId = urlParams.get('beach_id');
        const id = document.getElementById('teamId').value;
        const name = document.getElementById('teamName').value;
        const managerId = document.getElementById('managerId').value;
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);
        if(id) {
            // Sửa
            await fetch(`http://localhost:3009/api/Team/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    team_name: name,
                    manager_id: managerId,
                    location: { lat, lng }
                })
            });
        } else {
            // Thêm
            await fetch('http://localhost:3009/api/Team', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    team_id: 'T' + Date.now(),
                    team_name: name,
                    manager_id: managerId,
                    location: { lat, lng }
                })
            });
        }
        closeModal('teamModal');
        renderTeams();
    };
    renderTeams();
});
    </script>
    <script src="../js/auth.js"></script>

    <!-- Modal Thêm/Sửa đội cứu hộ -->
    <div id="teamModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teamModal')">&times;</span>
            <h2 id="teamModalTitle">Thêm đội cứu hộ</h2>
            <form id="teamForm">
                <input type="hidden" id="teamId">
                <input type="hidden" id="beachId" value="${beachId}">
                <div class="form-group">
                    <label for="beachId">Bãi biển</label>
                    <input type="text" id="beachId" value="${beachId}" disabled>
                </div>
                <div class="form-group">
                    <label for="teamId">Mã đội cứu hộ</label>
                    <input type="text" id="teamId" required>
                </div>
                <div class="form-group">
                    <label for="teamName">Tên đội cứu hộ</label>
                    <input type="text" id="teamName" required>
                </div>
                <div class="form-group">
                    <label for="managerId">Mã quản lý</label>
                    <input type="text" id="managerId" required>
                </div>
                <div class="form-group">
                    <label for="lat">Vĩ độ (lat)</label>
                    <input type="number" id="lat" step="any" required>
                </div>
                <div class="form-group">
                    <label for="lng">Kinh độ (lng)</label>
                    <input type="number" id="lng" step="any" required>
                </div>
                <button type="submit" class="btn btn-primary">Lưu</button>
            </form>
        </div>
    </div>
    <!-- Modal Xóa -->
    <div id="deleteTeamModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteTeamModal')">&times;</span>
            <h2>Xóa đội cứu hộ</h2>
            <p>Xóa thiệt hả bay T^T?</p>
            <button class="btn btn-danger" id="confirmDeleteTeamBtn">Xóa</button>
            <button class="btn" onclick="closeModal('deleteTeamModal')">Hoi má t nghĩ lại rùi</button>
        </div>
    </div>
</body>
</html>
app.get('/api/Team', async (req, res) => {
    const teams = await Team.find();
    res.json(teams);
});