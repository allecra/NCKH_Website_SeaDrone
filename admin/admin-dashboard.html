<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị hệ thống cứu hộ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #overviewMap { 
            width: 100%;
            height: 400px;
            border-radius: 8px;
            min-height: 400px;
        }
        .beach-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .beach-item:hover {
            background: #f0f4ff;
        }

        .beach-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 0.5rem;
        }
        .modal {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: #0005; display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 2rem; border-radius: 8px; min-width: 320px; position: relative;
        }
        .modal .close {
            position: absolute; right: 1rem; top: 1rem; cursor: pointer; font-size: 1.5rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; }
        .form-group input { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
        .btn { padding: 0.5rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
    </style>
</head>
<body>
    <div class="app-container" style="display: flex; flex-direction: column; min-height: 100vh;">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-life-ring logo-icon"></i>
                    <span>Hệ thống quản lý cứu hộ</span>
                </div>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 1rem;">
                <div class="user-info">
                    <i class="fas fa-user-circle user-icon"></i>
                    <span class="user-name">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>
        </header>

        <div class="breadcrumb">
            <div class="breadcrumb-container">
                <div class="breadcrumb-content">
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Quản lý bãi biển</span>
                    </div>
                </div>
            </div>
        </div>

        <main class="main-content" style="display: flex; gap: 2rem; align-items: flex-start;">
            <section class="map-section" style="flex: 1; min-width: 400px; position: relative;">
                <div class="section-header">
                    <div>
                        <h2>Bản đồ bãi biển</h2>
                        <p>Xem vị trí các bãi biển và đội cứu hộ</p>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm tên bãi biển...">
                        <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="map-container">
                    <div id="overviewMap"></div>
                </div>
            </section>

            <section class="list-section" style="flex: 1.2; min-width: 350px; max-height: 90vh; overflow-y: auto;">
                <div class="section-header" style="align-items: center; justify-content: space-between;">
                    <div>
                        <h2>Danh sách bãi biển</h2>
                        <p>Quản lý thông tin các bãi biển</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button class="btn btn-primary" id="addBeachBtn"><i class="fas fa-plus"></i> Thêm bãi biển</button>
                    </div>
                </div>
                <div class="beach-list">
                    <!-- Danh sách bãi biển sẽ được thêm vào đây -->
                </div>
            </section>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
let allBeaches = [];
async function fetchBeaches() {
    const res = await fetch('http://localhost:3009/api/Beach');
    allBeaches = await res.json();
    return allBeaches;
}
function filterBeaches(keyword) {
    if (!keyword) return allBeaches;
    return allBeaches.filter(b => b.beach_name.toLowerCase().includes(keyword.toLowerCase()));
}
document.getElementById('searchBtn').onclick = function() {
    const keyword = document.getElementById('searchInput').value;
    renderBeaches(keyword);
};
document.getElementById('searchInput').onkeyup = function(e) {
    if (e.key === 'Enter') document.getElementById('searchBtn').click();
};
async function renderBeaches(keyword = '') {
    const beaches = filterBeaches(keyword);
    const beachList = document.querySelector('.beach-list');
    beachList.innerHTML = beaches.map(beach => `
        <div class="beach-card" data-beach-id="${beach.beach_id}">
            <div class="beach-actions">
                <button class="btn btn-primary btn-edit" title="Sửa"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-delete" title="Xóa"><i class="fas fa-trash"></i></button>
            </div>
            <h3>${beach.beach_name}</h3>
            <div><b>Mã quản lý:</b> ${beach.manager_id}</div>
            <div><i class="fas fa-map-marker-alt"></i> <b>Vị trí:</b> ${beach.location?.lat}, ${beach.location?.lng}</div>
        </div>
    `).join('');
    // Gắn sự kiện click vào card để chuyển trang
    document.querySelectorAll('.beach-card').forEach(card => {
        card.onclick = function(e) {
            // Nếu click vào nút Sửa/Xóa thì không chuyển trang
            if (e.target.closest('.btn-edit') || e.target.closest('.btn-delete')) return;
            const id = card.getAttribute('data-beach-id');
            window.location.href = `teams.html?beach_id=${id}`;
        }
    });
    // Gắn sự kiện
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            const card = this.closest('.beach-card');
            openModal('beachModal', 'edit', card.getAttribute('data-beach-id'));
        }
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            const card = this.closest('.beach-card');
            openModal('deleteBeachModal', 'delete', card.getAttribute('data-beach-id'));
        }
    });
    renderMap(beaches);
}

function renderMap(beaches) {
    if (window._overviewMap) {
        window._overviewMap.remove();
    }
    if (!beaches || beaches.length === 0) return;
    const first = beaches.find(b => b.location && b.location.lat && b.location.lng);
    window._overviewMap = L.map('overviewMap').setView([
        first ? first.location.lat : 16.047079,
        first ? first.location.lng : 108.206230
    ], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(window._overviewMap);
    beaches.forEach(beach => {
        if (beach.location && beach.location.lat && beach.location.lng) {
            L.marker([beach.location.lat, beach.location.lng])
                .addTo(window._overviewMap)
                .bindPopup(`<b>${beach.beach_name}</b><br>${beach.location.lat}, ${beach.location.lng}`);
        }
    });
}

// Modal logic
function openModal(modalId, mode, id) {
    document.getElementById(modalId).style.display = 'flex';
    if(modalId === 'beachModal') {
        const title = document.getElementById('beachModalTitle');
        const form = document.getElementById('beachForm');
        if(mode === 'edit') {
            title.textContent = 'Sửa bãi biển';
            fetch(`http://localhost:3009/api/Beach`)
                .then(res => res.json())
                .then(beaches => {
                    const beach = beaches.find(b => b.beach_id === id);
                    document.getElementById('beachId').value = beach.beach_id;
                    document.getElementById('beachName').value = beach.beach_name;
                    document.getElementById('managerId').value = beach.manager_id;
                    document.getElementById('lat').value = beach.location?.lat || '';
                    document.getElementById('lng').value = beach.location?.lng || '';
                });
        } else {
            title.textContent = 'Thêm bãi biển';
            form.reset();
            document.getElementById('beachId').value = '';
        }
    }
    if(modalId === 'deleteBeachModal') {
        document.getElementById('confirmDeleteBeachBtn').onclick = async function() {
            await fetch(`http://localhost:3009/api/Beach/${id}`, { method: 'DELETE' });
            closeModal('deleteBeachModal');
            renderBeaches();
        }
    }
}
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Thêm/Sửa bãi biển
document.addEventListener('DOMContentLoaded', async () => {
    await fetchBeaches();
    renderBeaches();
    document.getElementById('addBeachBtn').onclick = function() {
        openModal('beachModal', 'add');
    };
});
    </script>
    <script src="../js/auth.js"></script>

    <!-- Modal Thêm/Sửa bãi biển -->
    <div id="beachModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('beachModal')">&times;</span>
            <h2 id="beachModalTitle">Thêm bãi biển</h2>
            <form id="beachForm">
                <input type="hidden" id="beachId">
                <div class="form-group">
                    <label for="beachName">Tên bãi biển</label>
                    <input type="text" id="beachName" required>
                </div>
                <div class="form-group">
                    <label for="managerId">Mã quản lý</label>
                    <input type="text" id="managerId" required>
                </div>
                <div class="form-group">
                    <label for="lat">Vĩ độ (lat)</label>
                    <input type="number" id="lat" step="any" required>
                </div>
                <div class="form-group">
                    <label for="lng">Kinh độ (lng)</label>
                    <input type="number" id="lng" step="any" required>
                </div>
                <button type="submit" class="btn btn-primary">Lưu</button>
            </form>
        </div>
    </div>
    <!-- Modal Xóa -->
    <div id="deleteBeachModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteBeachModal')">&times;</span>
            <h2>Xóa bãi biển</h2>
            <p>Bạn có chắc chắn muốn xóa bãi biển này?</p>
            <button class="btn btn-danger" id="confirmDeleteBeachBtn">Xóa</button>
            <button class="btn" onclick="closeModal('deleteBeachModal')">Hủy</button>
        </div>
    </div>
    <!-- Modal Báo cáo -->
    <div id="reportModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            <h2>Báo cáo thống kê</h2>
            <div id="reportContent">
                <!-- Nội dung thống kê sẽ được render ở đây -->
            </div>
        </div>
    </div>
</body>
</html>
