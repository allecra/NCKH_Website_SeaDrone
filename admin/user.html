<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách thành viên - Hệ thống quản lý cứu hộ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-life-ring logo-icon"></i>
                    <span>Hệ thống quản lý cứu hộ</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle user-icon"></i>
                    <span class="user-name">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>
        </header>

        <div class="breadcrumb">
            <div class="breadcrumb-container">
                <button class="back-btn" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại
                </button>
                <div class="breadcrumb-content">
                    <div class="location-info">
                        <i class="fas fa-users"></i>
                        <span>Danh sách thành viên</span>
                    </div>
                </div>
            </div>
        </div>

        <main class="main-content">
            <div class="team-info-container">
                <div class="team-header-info" style="display: flex; align-items: center; justify-content: space-between; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem; width: 100%; justify-content: space-between;">
                        <div class="team-status ${team.status}" style="display:inline-block;font-size:1.1rem;background:#e6f4ea;color:#1e7e34;padding:0.3rem 1.2rem;border-radius:14px;font-weight:600;min-width:110px;text-align:center;">
                            ${team.status === 'active' ? 'Hoạt động' : 'Không hoạt động'}
                        </div>
                        <h1 style="font-size: 2.2rem; margin: 0; text-align:center; flex:1;">${team.team_name}</h1>
                        <span style="font-size:1.1rem; min-width:120px; text-align:right;"><i class="fas fa-users"></i> ${members.length} thành viên</span>
                    </div>
                    <button class="btn btn-primary" id="addMemberBtn" style="margin-left:1.5rem;"><i class="fas fa-plus"></i> Thêm thành viên</button>
                </div>
                <div class="members-grid">
                    <!-- Danh sách thành viên sẽ được render ở đây -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Thêm/Sửa User -->
    <div class="modal-overlay" id="memberModal" style="display:none;">
      <div class="modal-content">
        <h3 id="memberModalTitle">Thêm thành viên</h3>
        <form id="memberForm">
          <input type="hidden" id="memberId">
          <div class="form-group">
            <label>Họ tên</label>
            <input type="text" id="memberName" required>
          </div>
          <div class="form-group">
            <label>Vai trò</label>
            <select id="memberRole">
              <option value="technical_monitor">Giám sát kỹ thuật</option>
              <option value="rescuer">Nhân viên cứu hộ</option>
            </select>
          </div>
          <div class="form-group">
            <label>Số điện thoại</label>
            <input type="text" id="memberPhone" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="memberEmail" required>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">Lưu</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('memberModal')">Hủy</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Modal xác nhận xóa member -->
    <div class="modal-overlay" id="deleteMemberModal" style="display:none;">
      <div class="modal-content">
        <h3>Xác nhận xóa</h3>
        <p>Bạn có chắc chắn muốn xóa thành viên này?</p>
        <div class="modal-actions">
          <button class="btn btn-danger" id="confirmDeleteMemberBtn">Xóa</button>
          <button class="btn btn-secondary" onclick="closeModal('deleteMemberModal')">Hủy</button>
        </div>
      </div>
    </div>

    <script type="module">
    // Lấy team_id từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const teamId = urlParams.get('team_id');

    async function renderMembers() {
        if (teamId) {
            // Lấy thông tin đội từ API
            const teamRes = await fetch(`http://localhost:3009/api/Team?team_id=${teamId}`);
            const teams = await teamRes.json();
            const team = Array.isArray(teams) ? teams[0] : teams;
            const members = await fetchMembersByTeamId(teamId);

            // Hiển thị thông tin đội
            const teamInfo = document.querySelector('.team-header-info');
            teamInfo.innerHTML = `
                <h1>${team.team_name}</h1>
                <div class="team-status ${team.status}" style="display:inline-block;margin-bottom:0;font-size:1.1rem;background:#e6f4ea;color:#1e7e34;padding:0.3rem 1.2rem;border-radius:14px;font-weight:600;">
                    ${team.status === 'active' ? 'Hoạt động' : 'Không hoạt động'}
                </div>
                <span style="font-size:1.1rem;"><i class="fas fa-users"></i> ${members.length} thành viên</span>
            `;

            // Hiển thị danh sách thành viên
            const membersGrid = document.querySelector('.members-grid');
            membersGrid.innerHTML = members.map(member => `
    <div class="member-card">
        <div class="member-avatar">
            ${
              member.avatar
                ? `<img src="${member.avatar}" alt="avatar" class="avatar-img" onerror="this.onerror=null;this.src='https://via.placeholder.com/80/636e72/fff?text=AVT';">`
                : `<i class="fas fa-user-circle"></i>`
            }
        </div>
        <div class="member-info">
            <h3>${member.fullname}</h3>
            <span class="member-role ${member.role}">
                ${member.role === 'technical_monitor' ? 'Giám sát kỹ thuật' : 'Nhân viên cứu hộ'}
            </span>
        </div>
        <div class="member-details">
            <div class="member-detail">
                <i class="fas fa-phone detail-icon"></i>
                <a href="tel:${member.phone}">${member.phone}</a>
            </div>
            <div class="member-detail">
                <i class="fas fa-envelope detail-icon"></i>
                <a href="mailto:${member.email}">${member.email}</a>
            </div>
        </div>
        <div class="member-actions" style="display:flex;gap:0.7rem;justify-content:center;margin-top:1.2rem;">
            <button class="btn btn-primary btn-small" onclick="openModal('memberModal', 'edit', '${member.user_id}')"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger btn-small" onclick="openModal('deleteMemberModal', 'delete', '${member.user_id}')"><i class="fas fa-trash"></i></button>
        </div>
    </div>
`).join('');
        }
    }

    window.openModal = async function(modalId, mode, id) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'flex';
        if(modalId === 'memberModal') {
            const title = document.getElementById('memberModalTitle');
            const form = document.getElementById('memberForm');
            if(mode === 'edit') {
                title.textContent = 'Sửa thành viên';
                // Lấy dữ liệu User từ API
                const res = await fetch(`http://localhost:3009/api/User?user_id=${id}`);
                const users = await res.json();
                const user = Array.isArray(users) ? users[0] : users;
                document.getElementById('memberId').value = user.user_id;
                document.getElementById('memberName').value = user.name;
                document.getElementById('memberRole').value = user.role;
                document.getElementById('memberPhone').value = user.phone;
                document.getElementById('memberEmail').value = user.email;
            } else {
                title.textContent = 'Thêm thành viên';
                form.reset();
                document.getElementById('memberId').value = '';
            }
        }
        if(modalId === 'deleteMemberModal') {
            document.getElementById('confirmDeleteMemberBtn').onclick = async function() {
                await fetch(`http://localhost:3009/api/User/${id}`, { method: 'DELETE' });
                closeModal('deleteMemberModal');
                renderMembers();
            };
        }
    }
    window.closeModal = function(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    document.body.addEventListener('click', function(e) {
        if(e.target && e.target.id === 'addMemberBtn') {
            openModal('memberModal', 'add');
        }
    });
    document.getElementById('memberForm').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('memberId').value;
        const name = document.getElementById('memberName').value;
        const role = document.getElementById('memberRole').value;
        const phone = document.getElementById('memberPhone').value;
        const email = document.getElementById('memberEmail').value;
        if(id) {
            // Sửa
            await fetch(`http://localhost:3009/api/User/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, role, phone, email, status: 'active' })
            });
        } else {
            // Thêm mới
            await fetch('http://localhost:3009/api/User', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: 'U' + Date.now(),
                    team_id: teamId,
                    name: name,
                    role,
                    phone,
                    email,
                    status: 'active'
                })
            });
        }
        closeModal('memberModal');
        renderMembers();
    }

    async function fetchMembersByTeamId(teamId) {
        const res = await fetch(`http://localhost:3009/api/User?team_id=${teamId}`);
        return await res.json();
    }

    renderMembers();
</script>
    <script src="../js/auth.js"></script>
</body>
</html>
