<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách thành viên - Hệ thống quản lý cứu hộ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-life-ring logo-icon"></i>
                    <span>Hệ thống quản lý cứu hộ</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle user-icon"></i>
                    <span class="user-name">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>
        </header>

        <div class="breadcrumb">
            <div class="breadcrumb-container">
                <button class="back-btn" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại
                </button>
                <div class="breadcrumb-content">
                    <div class="location-info">
                        <i class="fas fa-users"></i>
                        <span>Danh sách thành viên</span>
                    </div>
                </div>
            </div>
        </div>

        <main class="main-content">
            <div class="team-info-container">
                <div class="team-header-info">
                    <!-- Thông tin đội sẽ được thêm vào đây -->
                    <button class="btn btn-primary" id="addMemberBtn"><i class="fas fa-plus"></i> Thêm thành viên</button>
                </div>
                <div class="members-grid">
                    <!-- Danh sách thành viên sẽ được thêm vào đây -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Thêm/Sửa member -->
    <div class="modal-overlay" id="memberModal" style="display:none;">
      <div class="modal-content">
        <h3 id="memberModalTitle">Thêm thành viên</h3>
        <form id="memberForm">
          <input type="hidden" id="memberId">
          <div class="form-group">
            <label>Họ tên</label>
            <input type="text" id="memberName" required>
          </div>
          <div class="form-group">
            <label>Vai trò</label>
            <select id="memberRole">
              <option value="technical_monitor">Giám sát kỹ thuật</option>
              <option value="rescuer">Nhân viên cứu hộ</option>
            </select>
          </div>
          <div class="form-group">
            <label>Số điện thoại</label>
            <input type="text" id="memberPhone" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="memberEmail" required>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">Lưu</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('memberModal')">Hủy</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Modal xác nhận xóa member -->
    <div class="modal-overlay" id="deleteMemberModal" style="display:none;">
      <div class="modal-content">
        <h3>Xác nhận xóa</h3>
        <p>Bạn có chắc chắn muốn xóa thành viên này?</p>
        <div class="modal-actions">
          <button class="btn btn-danger" id="confirmDeleteMemberBtn">Xóa</button>
          <button class="btn btn-secondary" onclick="closeModal('deleteMemberModal')">Hủy</button>
        </div>
      </div>
    </div>

    <script type="module">
        import { getTeamById, getMembersByTeamId, DATABASE } from '../js/admin-data.js';

        // Lấy team_id từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const teamId = urlParams.get('team_id');

        async function renderMembers() {
            if (teamId) {
                // Lấy thông tin đội từ API
                const teamRes = await fetch(`http://localhost:3000/api/teams/${teamId}`);
                const team = await teamRes.json();
                const members = await fetchMembersByTeamId(teamId);

                // Hiển thị thông tin đội
                const teamInfo = document.querySelector('.team-header-info');
                teamInfo.innerHTML = `
                    <h1>${team.team_name}</h1>
                    <p class="team-username">@${team.username}</p>
                    <div class="team-status ${team.status}" style="display:inline-block;margin-bottom:1rem;">
                        ${team.status === 'active' ? 'Hoạt động' : 'Không hoạt động'}
                    </div>
                    <p style="margin-top:1rem;">${team.description || ''}</p>
                    <div style="margin:1.2rem 0 0.7rem 0;">
                        <span style="margin-right:1.5rem;"><i class="fas fa-clock"></i> ${team.schedule || ''}</span>
                        <span style="margin-right:1.5rem;"><i class="fas fa-tools"></i> ${(team.equipment || []).join(', ')}</span>
                        <span><i class="fas fa-users"></i> ${members.length} thành viên</span>
                    </div>
                    <button class="btn btn-primary" id="addMemberBtn"><i class="fas fa-plus"></i> Thêm thành viên</button>
                `;

                // Hiển thị danh sách thành viên
                const membersGrid = document.querySelector('.members-grid');
                membersGrid.innerHTML = members.map(member => `
                    <div class="member-card">
                        <div class="member-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="member-info">
                            <h3>${member.name}</h3>
                            <span class="member-role ${member.role}">
                                ${member.role === 'technical_monitor' ? 'Giám sát kỹ thuật' : 'Nhân viên cứu hộ'}
                            </span>
                        </div>
                        <div class="member-details">
                            <div class="member-detail">
                                <i class="fas fa-phone detail-icon"></i>
                                <a href="tel:${member.phone}">${member.phone}</a>
                            </div>
                            <div class="member-detail">
                                <i class="fas fa-envelope detail-icon"></i>
                                <a href="mailto:${member.email}">${member.email}</a>
                            </div>
                        </div>
                        <div class="member-actions">
                            <button class="btn btn-primary btn-small" onclick="openModal('memberModal', 'edit', '${member._id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-small" onclick="openModal('deleteMemberModal', 'delete', '${member._id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.openModal = async function(modalId, mode, id) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            if(modalId === 'memberModal') {
                const title = document.getElementById('memberModalTitle');
                const form = document.getElementById('memberForm');
                if(mode === 'edit') {
                    title.textContent = 'Sửa thành viên';
                    // Lấy dữ liệu member từ API
                    const res = await fetch(`http://localhost:3000/api/members/${id}`);
                    const member = await res.json();
                    document.getElementById('memberId').value = member._id;
                    document.getElementById('memberName').value = member.name;
                    document.getElementById('memberRole').value = member.role;
                    document.getElementById('memberPhone').value = member.phone;
                    document.getElementById('memberEmail').value = member.email;
                } else {
                    title.textContent = 'Thêm thành viên';
                    form.reset();
                    document.getElementById('memberId').value = '';
                }
            }
            if(modalId === 'deleteMemberModal') {
                document.getElementById('confirmDeleteMemberBtn').onclick = async function() {
                    await fetch(`http://localhost:3000/api/members/${id}`, { method: 'DELETE' });
                    closeModal('deleteMemberModal');
                    renderMembers();
                }
            }
        }
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        document.body.addEventListener('click', function(e) {
            if(e.target && e.target.id === 'addMemberBtn') {
                openModal('memberModal', 'add');
            }
        });
        document.getElementById('memberForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('memberId').value;
            const name = document.getElementById('memberName').value;
            const role = document.getElementById('memberRole').value;
            const phone = document.getElementById('memberPhone').value;
            const email = document.getElementById('memberEmail').value;
            if(id) {
                // Sửa
                await fetch(`http://localhost:3000/api/members/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        role,
                        phone,
                        email
                    })
                });
            } else {
                // Thêm
                await fetch('http://localhost:3000/api/members', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team_id: teamId,
                        name,
                        role,
                        phone,
                        email,
                        status: 'active'
                    })
                });
            }
            closeModal('memberModal');
            renderMembers();
        }

        async function fetchTeamsByBeachId(beachId) {
            const res = await fetch(`http://localhost:3000/api/teams`);
            const allTeams = await res.json();
            return allTeams.filter(team => team.beach_id === beachId);
        }

        async function renderTeams() {
            const teamsList = document.querySelector('.teams-list');
            const teams = await fetchTeamsByBeachId(beachId);
            teamsList.innerHTML = teams.map(team => `
                <div class="team-item" data-team-id="${team.team_id}">
                    <div class="team-header" style="display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <h3>${team.team_name}</h3>
                            <span class="team-status ${team.status}">${team.status === 'active' ? 'Hoạt động' : 'Không hoạt động'}</span>
                        </div>
                        <div class="team-actions">
                        <!-- ... -->
                        </div>
                    </div>
                </div>
            `).join('');
        }

        renderMembers();
    </script>
    <script src="../js/auth.js"></script>
</body>
</html>
