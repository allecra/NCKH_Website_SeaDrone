<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách thành viên - Hệ thống quản lý cứu hộ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-life-ring logo-icon"></i>
                    <span>Hệ thống quản lý cứu hộ bãi biển</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle user-icon"></i>
                    <span class="user-name">Technical Monitor</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>
        </header>

        <div class="breadcrumb">
            <div class="breadcrumb-container">
                <button class="back-btn" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại
                </button>
                <div class="breadcrumb-content">
                    <div class="location-info">
                        <i class="fas fa-users"></i>
                        <span>Danh sách thành viên</span>
                    </div>
                </div>
            </div>
        </div>

        <main class="main-content">
            <div class="team-info-container">
                <div class="team-header-info">
                    <!-- Thông tin đội sẽ được thêm vào đây -->
                    <button class="btn btn-primary" id="addMemberBtn"><i class="fas fa-plus"></i> Thêm thành viên</button>
                </div>
                <div class="members-grid">
                    <!-- Danh sách thành viên sẽ được render ở đây -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Thêm/Sửa User -->
    <div class="modal-overlay" id="memberModal" style="display:none;">
      <div class="modal-content">
        <h3 id="memberModalTitle">Thêm thành viên</h3>
        <form id="memberForm">
          <input type="hidden" id="memberId">
          <div class="form-group">
            <label>Họ tên</label>
            <input type="text" id="memberName" required>
          </div>
          <div class="form-group">
            <label>Vai trò</label>
            <select id="memberRole">
              <option value="technical_monitor">Giám sát kỹ thuật</option>
              <option value="rescuer">Nhân viên cứu hộ</option>
            </select>
          </div>
          <div class="form-group">
            <label>Số điện thoại</label>
            <input type="text" id="memberPhone" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="memberEmail" required>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">Lưu</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('memberModal')">Hủy</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Modal xác nhận xóa member -->
    <div class="modal-overlay" id="deleteMemberModal" style="display:none;">
      <div class="modal-content">
        <h3>Xác nhận xóa</h3>
        <p>Bạn có chắc chắn muốn xóa thành viên này?</p>
        <div class="modal-actions">
          <button class="btn btn-danger" id="confirmDeleteMemberBtn">Xóa</button>
          <button class="btn btn-secondary" onclick="closeModal('deleteMemberModal')">Hủy</button>
        </div>
      </div>
    </div>

    <script type="module">
    // Lấy team_id từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const teamId = urlParams.get('team_id');

    async function renderMembers() {
        if (teamId) {
            // Lấy thông tin đội từ API
            const teamRes = await fetch(`http://localhost:3009/api/Team?team_id=${teamId}`);
            const teams = await teamRes.json();
            const team = Array.isArray(teams) ? teams[0] : teams;
            const members = await fetchMembersByTeamId(teamId);
            console.log('API members:', members);

            // Hiển thị thông tin đội
            const teamInfo = document.querySelector('.team-header-info');
            teamInfo.style.display = 'flex';
            teamInfo.style.alignItems = 'center';
            teamInfo.style.justifyContent = 'center';
            teamInfo.style.gap = '24px';
            teamInfo.style.margin = '32px 0 0 0';
            teamInfo.innerHTML = `
                <h1 style="font-size:2.2rem;font-weight:800;margin:0 18px 0 0;letter-spacing:1px;">${team.team_name || 'Tên đội'}</h1>
                <div class="team-status ${team.status}" style="display:inline-block;margin-bottom:0;font-size:1.1rem;padding:7px 18px;border-radius:16px;font-weight:600;${team.status==='active' ? 'background:#69f0ae;color:#00695c;' : 'background:#eee;color:#888;'}">
                    ${team.status === 'active' ? 'Hoạt động' : 'Không hoạt động'}
                </div>
                <span style="font-size:1.1rem;color:#333;"><i class="fas fa-users"></i> ${members.length} thành viên</span>
                <button class="btn btn-primary" id="addMemberBtn" style="font-size:1.1rem;padding:10px 22px;border-radius:12px;background:linear-gradient(90deg,#5f72bd,#9a5be4);color:#fff;font-weight:600;box-shadow:0 2px 8px #0001;display:flex;align-items:center;gap:8px;"><i class="fas fa-plus"></i> Thêm thành viên</button>
            `;

            // Hiển thị danh sách thành viên
            const membersGrid = document.querySelector('.members-grid');
            membersGrid.style.display = 'grid';
            membersGrid.style.gridTemplateColumns = 'repeat(4, 1fr)';
            membersGrid.style.gap = '32px';
            membersGrid.style.justifyItems = 'center';
            membersGrid.style.margin = '32px auto 0 auto';
            membersGrid.style.maxWidth = '1400px';

            // Thêm responsive cho grid
            const style = document.createElement('style');
            style.innerHTML = `
            @media (max-width: 1200px) {
              .members-grid { grid-template-columns: repeat(2, 1fr) !important; }
            }
            @media (max-width: 700px) {
              .members-grid { grid-template-columns: 1fr !important; }
            }
            `;
            document.head.appendChild(style);

            membersGrid.innerHTML = members.map(member => `
  <div class="member-card" style="background:#fff;border-radius:20px;box-shadow:0 2px 12px #0001;padding:32px 24px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;min-width:300px;max-width:500px;transition:box-shadow .2s;">
    <div class="member-avatar" style="margin-bottom:16px;">
      ${member.avatar
        ? `<img src="${member.avatar}" alt="avatar" class="avatar-img" style="width:90px;height:90px;border-radius:50%;object-fit:cover;box-shadow:0 2px 8px #0002;" onerror="this.onerror=null;this.src='https://via.placeholder.com/90/636e72/fff?text=AVT';">`
        : `<i class="fas fa-user-circle" style="font-size:90px;color:#222;"></i>`}
    </div>
    <div class="member-info" style="text-align:center;">
      <h3 style="margin:0 0 8px 0;font-size:1.25rem;font-weight:700;letter-spacing:0.5px;">${member.fullname || member.name || 'Chưa cập nhật'}</h3>
      <span class="member-role ${member.role}" style="display:inline-block;padding:7px 20px;border-radius:16px;font-size:1rem;font-weight:500;margin-bottom:10px;${member.role==='technical_monitor' ? 'background:#ffe082;color:#795548;' : 'background:#69f0ae;color:#00695c;'}">
        ${member.role === 'technical_monitor' ? 'Giám sát kỹ thuật' : 'Nhân viên cứu hộ'}
      </span>
    </div>
    <div class="member-details" style="margin:12px 0 18px 0;">
      <div class="member-detail" style="margin-bottom:4px;">
        <i class="fas fa-phone detail-icon"></i>
        <a href="tel:${member.phone}" style="color:#222;text-decoration:none;font-size:1rem;">${member.phone || ''}</a>
      </div>
      <div class="member-detail">
        <i class="fas fa-envelope detail-icon"></i>
        <a href="mailto:${member.email}" style="color:#222;text-decoration:none;font-size:1rem;">${member.email || ''}</a>
      </div>
    </div>
    <div class="member-actions" style="display:flex;gap:16px;">
      <button class="btn btn-primary btn-small" style="background:#1976d2;padding:10px 18px;border-radius:8px;transition:background .2s;" onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1976d2'" onclick="openModal('memberModal', 'edit', '${member.user_id}')"><i class="fas fa-edit"></i></button>
      <button class="btn btn-danger btn-small" style="background:#e53935;padding:10px 18px;border-radius:8px;transition:background .2s;" onmouseover="this.style.background='#b71c1c'" onmouseout="this.style.background='#e53935'" onclick="openModal('deleteMemberModal', 'delete', '${member.user_id}')"><i class="fas fa-trash"></i></button>
    </div>
  </div>
`).join('');
        }
    }

    window.openModal = async function(modalId, mode, id) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'flex';
        if(modalId === 'memberModal') {
            const title = document.getElementById('memberModalTitle');
            const form = document.getElementById('memberForm');
            if(mode === 'edit') {
                title.textContent = 'Sửa thành viên';
                // Lấy dữ liệu User từ API
                const res = await fetch(`http://localhost:3009/api/User?user_id=${id}`);
                const users = await res.json();
                const user = Array.isArray(users) ? users[0] : users;
                document.getElementById('memberId').value = user.user_id;
                document.getElementById('memberName').value = user.name;
                document.getElementById('memberRole').value = user.role;
                document.getElementById('memberPhone').value = user.phone;
                document.getElementById('memberEmail').value = user.email;
            } else {
                title.textContent = 'Thêm thành viên';
                form.reset();
                document.getElementById('memberId').value = '';
            }
        }
        if(modalId === 'deleteMemberModal') {
            document.getElementById('confirmDeleteMemberBtn').onclick = async function() {
                await fetch(`http://localhost:3009/api/User/${id}`, { method: 'DELETE' });
                closeModal('deleteMemberModal');
                renderMembers();
            };
        }
    }
    window.closeModal = function(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    document.body.addEventListener('click', function(e) {
        if(e.target && e.target.id === 'addMemberBtn') {
            openModal('memberModal', 'add');
        }
    });
    document.getElementById('memberForm').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('memberId').value;
        const name = document.getElementById('memberName').value;
        const role = document.getElementById('memberRole').value;
        const phone = document.getElementById('memberPhone').value;
        const email = document.getElementById('memberEmail').value;
        if(id) {
            // Sửa
            await fetch(`http://localhost:3009/api/User/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, role, phone, email, status: 'active' })
            });
        } else {
            // Thêm mới
            await fetch('http://localhost:3009/api/User', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: 'U' + Date.now(),
                    team_id: teamId,
                    name: name,
                    role,
                    phone,
                    email,
                    status: 'active'
                })
            });
        }
        closeModal('memberModal');
        renderMembers();
    }

    async function fetchMembersByTeamId(teamId) {
        const res = await fetch(`http://localhost:3009/api/User?team_id=${teamId}`);
        const data = await res.json();
        return Array.isArray(data) ? data : (data.data || []);
    }

    renderMembers();

    // Sửa lại phần header
    const appHeader = document.querySelector('.app-header');
    if (appHeader) {
        appHeader.style.background = '#fff';
        appHeader.style.boxShadow = '0 2px 16px #0001';
        appHeader.style.borderBottomLeftRadius = '24px';
        appHeader.style.borderBottomRightRadius = '24px';
        appHeader.style.display = 'flex';
        appHeader.style.justifyContent = 'space-between';
        appHeader.style.alignItems = 'center';
        appHeader.style.padding = '18px 40px 18px 40px';
    }
    const logo = document.querySelector('.logo');
    if (logo) {
        logo.style.display = 'flex';
        logo.style.alignItems = 'center';
        logo.style.fontSize = '1.5rem';
        logo.style.fontWeight = 'bold';
        logo.style.color = '#3f51b5';
    }
    const headerRight = document.querySelector('.header-right');
    if (headerRight) {
        headerRight.style.display = 'flex';
        headerRight.style.alignItems = 'center';
        headerRight.style.gap = '18px';
    }
    const logoutBtn = document.querySelector('.logout-btn');
    if (logoutBtn) {
        logoutBtn.style.background = 'linear-gradient(90deg,#5f72bd,#9a5be4)';
        logoutBtn.style.color = '#fff';
        logoutBtn.style.border = 'none';
        logoutBtn.style.borderRadius = '24px';
        logoutBtn.style.padding = '10px 22px';
        logoutBtn.style.fontWeight = '600';
        logoutBtn.style.fontSize = '1rem';
        logoutBtn.style.boxShadow = '0 2px 8px #0001';
        logoutBtn.style.display = 'flex';
        logoutBtn.style.alignItems = 'center';
        logoutBtn.style.gap = '8px';
        logoutBtn.onmouseover = function() { this.style.background = 'linear-gradient(90deg,#4e54c8,#8f94fb)'; };
        logoutBtn.onmouseout = function() { this.style.background = 'linear-gradient(90deg,#5f72bd,#9a5be4)'; };
    }
    // Sửa lại nút quay lại
    const backBtn = document.querySelector('.back-btn');
    if (backBtn) {
        backBtn.style.background = '#f3f6fd';
        backBtn.style.color = '#3f51b5';
        backBtn.style.border = 'none';
        backBtn.style.borderRadius = '24px';
        backBtn.style.padding = '10px 22px';
        backBtn.style.fontWeight = '600';
        backBtn.style.fontSize = '1rem';
        backBtn.style.boxShadow = '0 2px 8px #0001';
        backBtn.style.display = 'flex';
        backBtn.style.alignItems = 'center';
        backBtn.style.gap = '8px';
        backBtn.onmouseover = function() { this.style.background = '#e3e7f7'; };
        backBtn.onmouseout = function() { this.style.background = '#f3f6fd'; };
    }
    // Sửa lại tiêu đề breadcrumb
    const breadcrumbContent = document.querySelector('.breadcrumb-content');
    if (breadcrumbContent) {
        breadcrumbContent.style.fontSize = '1.2rem';
        breadcrumbContent.style.fontWeight = '700';
        breadcrumbContent.style.color = '#222';
        breadcrumbContent.style.display = 'flex';
        breadcrumbContent.style.alignItems = 'center';
        breadcrumbContent.style.gap = '8px';
    }
</script>
    <script src="../js/auth.js"></script>
</body>
</html>
